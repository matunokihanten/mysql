<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>究極のモグラたたきチャレンジ！</title>
  <style>
    body {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: radial-gradient(circle, #ffe6f2 0%, #ffcce6 100%);
      color: #333;
      text-align: center;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    h1 {
      color: #d6336c;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
      font-size: 2.5rem;
      margin-top: 20px;
    }
    #status {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-size: 1.5rem;
      margin: 20px 0;
      padding: 10px;
      background: rgba(255,255,255,0.7);
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    #game-container {
      display: grid;
      grid-template-columns: repeat(3, 150px);
      grid-gap: 20px;
      justify-content: center;
      margin: 20px auto;
    }
    .hole {
      width: 150px;
      height: 150px;
      background: #8B4513;
      border: 5px solid #654321;
      border-radius: 50%;
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    .mole, .gold-mole, .bomb-mole {
      width: 100px;
      height: 100px;
      position: absolute;
      bottom: -100px;
      left: 25px;
      transition: bottom 0.2s ease-out, transform 0.1s ease-in-out;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      border-radius: 50%;
    }
    .mole {
      background: radial-gradient(circle at 50% 20%, #A0522D 0%, #8B4513 70%);
    }
    .gold-mole {
      background: radial-gradient(circle at 50% 20%, #FFD700 0%, #DAA520 70%);
    }
    .bomb-mole {
      background: radial-gradient(circle at 50% 20%, #444 0%, #222 70%);
    }

    /* モグラの顔のデザイン */
    .mole-eye, .gold-mole-eye, .bomb-mole-eye {
        position: absolute;
        width: 15px;
        height: 15px;
        background-color: white;
        border-radius: 50%;
        border: 2px solid black;
        top: 25px;
    }
    .mole-eye:nth-child(1), .gold-mole-eye:nth-child(1), .bomb-mole-eye:nth-child(1) { left: 20px; }
    .mole-eye:nth-child(2), .gold-mole-eye:nth-child(2), .bomb-mole-eye:nth-child(2) { left: 65px; }

    .gold-mole-eye { background-color: #f00; }
    .bomb-mole-eye { background-color: #f00; }

    .mole-mouth, .gold-mole-mouth, .bomb-mole-mouth {
        position: absolute;
        bottom: 25px;
        width: 30px;
        height: 10px;
        border-radius: 0 0 10px 10px;
        border: 2px solid black;
        border-top: none;
        left: 35px;
    }
    .mole-mouth { background-color: #f0f; }
    .gold-mole-mouth { background-color: #f00; }
    .bomb-mole-mouth { background-color: #444; }

    .mole-whisker {
        position: absolute;
        width: 25px;
        height: 1px;
        background-color: black;
        top: 50px;
    }
    .mole-whisker:nth-child(3) { left: 10px; transform: rotate(15deg); }
    .mole-whisker:nth-child(4) { left: 10px; transform: rotate(0deg); }
    .mole-whisker:nth-child(5) { left: 10px; transform: rotate(-15deg); }
    .mole-whisker:nth-child(6) { right: 10px; transform: rotate(-15deg); }
    .mole-whisker:nth-child(7) { right: 10px; transform: rotate(0deg); }
    .mole-whisker:nth-child(8) { right: 10px; transform: rotate(15deg); }

    .mole-up { bottom: 25px; }
    .mole:active, .gold-mole:active, .bomb-mole:active { transform: scale(0.95); }

    #start-btn {
      margin: 25px;
      padding: 15px 30px;
      font-size: 1.5rem;
      font-weight: bold;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #start-btn:hover { background: #45a049; }
    #leaderboard {
      margin: 20px auto;
      width: 80%;
      background: rgba(255,255,255,0.8);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f2f2f2;
      color: #333;
    }
    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #f1f1f1; }

    .final-score {
        font-size: 3rem;
        font-weight: bold;
        color: #d6336c;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <h1>究極のモグラたたきチャレンジ！</h1>
  <div id="status">
    <div id="score">スコア: 0</div>
    <div id="timer">残り時間: 60秒</div>
    <div id="level">レベル: 1</div>
    <div id="combo">コンボ: 0</div>
  </div>
  <div id="game-container">
    <div class="hole" id="hole0"></div>
    <div class="hole" id="hole1"></div>
    <div class="hole" id="hole2"></div>
    <div class="hole" id="hole3"></div>
    <div class="hole" id="hole4"></div>
    <div class="hole" id="hole5"></div>
    <div class="hole" id="hole6"></div>
    <div class="hole" id="hole7"></div>
    <div class="hole" id="hole8"></div>
  </div>
  <button id="start-btn">スタート</button>

  <h2>リーダーボード</h2>
  <div id="leaderboard">
    <table>
      <thead>
        <tr>
          <th>順位</th>
          <th>プレイヤー</th>
          <th>スコア</th>
          <th>日時</th>
        </tr>
      </thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
  </div>

  <audio id="hit-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" preload="auto"></audio>
  <audio id="miss-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3" preload="auto"></audio>
  <audio id="gameover-sound" src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3" preload="auto"></audio>

  <script>
    let score = 0, timer = 60, level = 1, combo = 0;
    let playerName = "名無し";
    let countdownInterval, moleInterval;
    const scoreDisplay = document.getElementById('score');
    const timerDisplay = document.getElementById('timer');
    const levelDisplay = document.getElementById('level');
    const comboDisplay = document.getElementById('combo');
    const startBtn = document.getElementById('start-btn');
    const holes = document.querySelectorAll('.hole');

    const hitSound = document.getElementById('hit-sound');
    const missSound = document.getElementById('miss-sound');
    const gameoverSound = document.getElementById('gameover-sound');

    // プレイヤー名の入力を求める
    function promptPlayerName() {
        const name = prompt("プレイヤー名を入力してください：", "名無し");
        if (name) {
            playerName = name;
        }
    }

    // ランダムな穴とモグラの種類を返す
    function randomHoleAndMole() {
        const random = Math.floor(Math.random() * holes.length);
        const hole = holes[random];
        let moleType = 'mole';
        const moleChance = Math.random();

        if (moleChance < 0.1) {
            moleType = 'gold-mole';
        } else if (moleChance > 0.9) {
            moleType = 'bomb-mole';
        }
        return { hole, moleType };
    }

    // モグラの表示
    function showMole() {
        // すべてのモグラを一度削除
        document.querySelectorAll('.mole, .gold-mole, .bomb-mole').forEach(m => m.remove());

        let moleCount = Math.min(2 + Math.floor(level / 5), 5);
        for (let i = 0; i < moleCount; i++) {
            const { hole, moleType } = randomHoleAndMole();
            if (hole.querySelector('.mole, .gold-mole, .bomb-mole')) continue;

            const mole = document.createElement('div');
            mole.classList.add(moleType);
            mole.classList.add('mole-up');

            // 顔のパーツを追加
            const eye1 = document.createElement('div');
            eye1.classList.add(moleType + '-eye');
            eye1.style.left = '20px';
            mole.appendChild(eye1);

            const eye2 = document.createElement('div');
            eye2.classList.add(moleType + '-eye');
            eye2.style.left = '65px';
            mole.appendChild(eye2);

            const mouth = document.createElement('div');
            mouth.classList.add(moleType + '-mouth');
            mole.appendChild(mouth);

            // ひげを追加
            for (let j = 0; j < 3; j++) {
                const whiskerLeft = document.createElement('div');
                whiskerLeft.classList.add('mole-whisker');
                whiskerLeft.style.left = '10px';
                whiskerLeft.style.top = `${50 + j * 5 - 5}px`;
                whiskerLeft.style.transform = `rotate(${j * 15 - 15}deg)`;
                mole.appendChild(whiskerLeft);

                const whiskerRight = document.createElement('div');
                whiskerRight.classList.add('mole-whisker');
                whiskerRight.style.right = '10px';
                whiskerRight.style.top = `${50 + j * 5 - 5}px`;
                whiskerRight.style.transform = `rotate(${-j * 15 + 15}deg)`;
                mole.appendChild(whiskerRight);
            }
            
            mole.addEventListener('click', () => hitMole(mole, moleType));
            hole.appendChild(mole);

            setTimeout(() => {
                if (hole.contains(mole)) {
                    mole.classList.remove('mole-up');
                    setTimeout(() => {
                        if (hole.contains(mole)) mole.removeChild(mole);
                    }, 200);
                    if (moleType !== 'bomb-mole') {
                        combo = 0;
                        comboDisplay.textContent = "コンボ: " + combo;
                        missSound.play();
                    }
                }
            }, Math.max(1000 - level * 50, 300));
        }
    }

    // モグラを叩いたときの処理
    function hitMole(moleElement, type) {
        moleElement.classList.remove('mole-up');
        setTimeout(() => moleElement.remove(), 200);

        let points = 0;
        if (type === 'gold-mole') {
            points = 5;
            combo++;
        } else if (type === 'bomb-mole') {
            points = -5;
            combo = 0;
        } else {
            points = 1;
            combo++;
        }

        const comboBonus = Math.floor(combo / 5);
        score += points + comboBonus;
        score = Math.max(0, score);

        scoreDisplay.textContent = "スコア: " + score;
        comboDisplay.textContent = "コンボ: " + combo;

        if (type !== 'bomb-mole') {
            hitSound.play();
        } else {
            missSound.play();
        }
    }

    // ゲーム開始
    function startGame() {
        promptPlayerName();
        score = 0; timer = 60; level = 1; combo = 0;
        scoreDisplay.textContent = "スコア: 0";
        timerDisplay.textContent = "残り時間: 60秒";
        levelDisplay.textContent = "レベル: 1";
        comboDisplay.textContent = "コンボ: 0";
        startBtn.disabled = true;

        countdownInterval = setInterval(() => {
            timer--;
            timerDisplay.textContent = "残り時間: " + timer + "秒";
            if (timer % 10 === 0) {
                level++;
                levelDisplay.textContent = "レベル: " + level;
            }
            if (timer <= 0) endGame();
        }, 1000);

        moleInterval = setInterval(showMole, Math.max(1000 - level * 10, 300));
    }

    // ゲーム終了
    function endGame() {
        clearInterval(countdownInterval);
        clearInterval(moleInterval);
        startBtn.disabled = false;
        gameoverSound.play();

        alert(`ゲームオーバー！\nプレイヤー名: ${playerName}\n最終スコア: ${score}`);
        scoreDisplay.innerHTML = `<div class="final-score">最終スコア: ${score}</div>`;
        submitScore();
        loadLeaderboard();
    }

    // スコア送信
    function submitScore() {
        fetch('update_score.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ player_name: playerName, final_score: score })
        })
        .then(response => response.text())
        .then(data => console.log(data))
        .catch(error => console.error('エラー:', error));
    }

    // リーダーボード読み込み
    function loadLeaderboard() {
        fetch('leaderboard.php')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('leaderboard-body');
                tbody.innerHTML = "";
                data.forEach((entry, index) => {
                    let row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${entry.player_name}</td>
                        <td>${entry.score}</td>
                        <td>${entry.created_at}</td>
                    `;
                    tbody.appendChild(row);
                });
            })
            .catch(error => console.error('リーダーボード読み込みエラー:', error));
    }

    startBtn.addEventListener('click', startGame);
    loadLeaderboard();
  </script>
</body>
</html>